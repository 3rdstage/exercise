<beans xmlns="http://www.springframework.org/schema/beans"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
      http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd">

   <!-- Allows us to use system properties as variables in this configuration file -->
   <bean class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
      <property name="properties">
         <props>
            <prop key="activemq.username">system</prop>
            <prop key="activemq.password">manager</prop>
            <prop key="guest.password">password</prop>
         </props>
      </property>
      <!-- <property name="locations"> <value>file:${activemq.conf}/credentials.properties</value> </property> -->
      <property name="searchSystemEnvironment" value="true" />
      <property name="systemPropertiesModeName" value="SYSTEM_PROPERTIES_MODE_OVERRIDE" />
   </bean>

   <!-- Allows accessing the server log -->
   <!-- <bean id="logQuery" class="io.fabric8.insight.log.log4j.Log4jLogQuery" lazy-init="false" scope="singleton" init-method="start" destroy-method="stop"> </bean> -->
   <!-- The <broker> element is used to configure the ActiveMQ broker. -->
   <broker xmlns="http://activemq.apache.org/schema/core" brokerName="WordStatsBroker" dataDirectory="${TEMP}/activemq">
      <destinationPolicy>
         <policyMap>
            <policyEntries>
               <policyEntry topic=">">
                  <!-- The constantPendingMessageLimitStrategy is used to prevent slow topic consumers to block producers and affect other consumers by limiting
                     the number of messages that are retained For more information, see: http://activemq.apache.org/slow-consumer-handling.html -->
                  <pendingMessageLimitStrategy>
                     <constantPendingMessageLimitStrategy limit="1000" />
                  </pendingMessageLimitStrategy>
               </policyEntry>
            </policyEntries>
         </policyMap>
      </destinationPolicy>

      <!-- The managementContext is used to configure how ActiveMQ is exposed in JMX. By default, ActiveMQ uses the MBean server that is started by the JVM. For
         more information, see: http://activemq.apache.org/jmx.html -->
      <managementContext>
         <managementContext createConnector="false" />
      </managementContext>
      <!-- Configure message persistence for the broker. The default persistence mechanism is the KahaDB store (identified by the kahaDB tag). For more information,
         see: http://activemq.apache.org/persistence.html -->
      <persistenceAdapter>
         <kahaDB directory="${TEMP}/kahadb" />
      </persistenceAdapter>

      <!-- The systemUsage controls the maximum amount of space the broker will use before disabling caching and/or slowing down producers. For more information,
         see: http://activemq.apache.org/producer-flow-control.html -->
      <systemUsage>
         <systemUsage>
            <memoryUsage>
               <memoryUsage percentOfJvmHeap="70" />
            </memoryUsage>
            <storeUsage>
               <storeUsage limit="100 gb" />
            </storeUsage>
            <tempUsage>
               <tempUsage limit="50 gb" />
            </tempUsage>
         </systemUsage>
      </systemUsage>
      <!-- The transport connectors expose ActiveMQ over a given protocol to clients and other brokers. For more information, see: http://activemq.apache.org/configuring-transports.html -->
      <transportConnectors>
         <transportConnector name="openwire" uri="tcp://127.0.0.1:61606?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600" />
      </transportConnectors>
      <!-- destroy the spring context on shutdown to stop jetty -->
      <shutdownHooks>
         <bean xmlns="http://www.springframework.org/schema/beans" class="org.apache.activemq.hooks.SpringContextHook" />
      </shutdownHooks>
   </broker>

   <bean id="ampWebConsoleConfigurer"
      class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
      <property name="targetObject">
         <bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
            <property name="targetClass" value="java.lang.System"/>
            <property name="targetMethod" value="getProperties"/>
         </bean>
      </property>
      <property name="targetMethod" value="putAll"/>
         <property name="arguments">
            <props>
               <prop key="webconsole.type">properties</prop>
               <prop key="webconsole.jms.url">tcp://127.0.0.1:61606</prop>
            </props>
         </property>
   </bean>

   <bean id="webContexts" class="org.eclipse.jetty.server.handler.ContextHandlerCollection">
      <property name="handlers">
         <list>
            <bean class="org.eclipse.jetty.webapp.WebAppContext">
               <property name="war" value="${TEMP}/activemq-web-console-5.13.2.war" />
               <property name="contextPath" value="/admin"/>
               <property name="extractWAR" value="true"/>
               <property name="logUrlOnStart" value="true"/>
            </bean>
         </list>
      </property>
   </bean>

   <bean id="Server" name="Main"
      class="org.eclipse.jetty.server.Server" depends-on="ampWebConsoleConfigurer"
      init-method="start" destroy-method="stop">
      <constructor-arg>
         <bean id="threadPool" class="org.eclipse.jetty.util.thread.QueuedThreadPool">
            <property name="minThreads" value="10" />
            <property name="maxThreads" value="50" />
         </bean>
      </constructor-arg>
      <property name="connectors">
         <list>
            <bean id="connector" class="org.eclipse.jetty.server.ServerConnector">
               <constructor-arg ref="Server" />
               <property name="host" value="127.0.0.1" />
               <property name="port" value="8161" />
            </bean>
         </list>
      </property>
      <property name="handler">
         <bean id="handlers" class="org.eclipse.jetty.server.handler.HandlerCollection">
            <property name="handlers">
               <list>
                  <ref bean="webContexts" />
                  <bean id="defaultHandler" class="org.eclipse.jetty.server.handler.DefaultHandler" />
               </list>
            </property>
         </bean>
      </property>
      <property name="beans">
         <list>
            <bean id="deploymentManager" class="org.eclipse.jetty.deploy.DeploymentManager">
               <property name="contexts" ref="webContexts" />
               <!-- <property name="appProviders"> <list> <bean id="webAppProvider" class="org.eclipse.jetty.deploy.providers.WebAppProvider"> <property name="monitoredDirName"
                  value="webapps"/> <property name="scanInterval" value="1"/> <property name="extractWars" value="true"/> </bean> </list> </property> -->
            </bean>
         </list>
      </property>
   </bean>
</beans>