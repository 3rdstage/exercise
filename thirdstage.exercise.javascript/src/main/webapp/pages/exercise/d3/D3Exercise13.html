<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>D3.js Exercise - Real-time line chart</title>
<link rel="stylesheet" href="../../../styles/bootstrap/bootstrap.min.css">
<script type="text/javascript" src="../../../scripts/underscore/underscore.js"></script>
<script type="text/javascript" src="../../../scripts/jquery/js/jquery-1.8.0.min.js"></script>
<script type="text/javascript" src="../../../scripts/bootstrap/bootstrap.min.js"></script>
<script type='text/javascript' src='../../../scripts/d3/d3.min.js'></script>
<script type='text/javascript' src='../../../scripts/moment/moment-with-langs.js'></script>


	<style type="text/css">
		body {
			margin-left:20px;
		}

		.chart .axis path, .chart .axis line .area{
			fill:none;
			stroke:black;
			shape-rendering:crispEdges;
		}

		.chart .axis text{
			font-family:sans-serif;
			font-size:11px;
		}

		.chart path{
			fill:none;
			stroke:black;
		}

	</style>
</head>
<body>


	<table>
		<tr>
			<td>
				<div id="chart1" class="panel-collapse">
					<div class="display" style="margin-top:10px">
					</div>
				</div>
			</td>
			<td width="20">&nbsp;</td>
			<td>
				<div id="chart2" class="panel-collapse">
					<div class="display" style="margin-top:10px">
					</div>
				</div>
			</td>
		</tr>
	</table>


	<div>
		<svg width="600" height="2400"></div>
		
	</div>	


	<script>
	
	function realtimeChart(options, initData, updateData){
		"use strict";
		
		var container = options.container; //mandatory
		
		//{width : int, heigh : int} is expected
		var dimensions = options.dimensions;
		
		//{top : int, right : int, bottom : int, left : int} is expected. 
		var paddings = options.paddings; 
		
		var range; //pure derived, so should not specified from external
		
		var interval = options.interval; //int value is expected.
		
		var now;
		
		//{ x : [date, date], y : [int, int]} is expected.
		var domains = options.domains;
		 
		//{x : int, y : int} is expected
		var ticks = options.ticks; 
		
		//int value is expected.
		var r = options.r;

		var data = [];
		 
		var chart;
		var scales;
		var axis;
		var line;
		var path;

		if(dimensions === undefined) dimensions = {width : 800, height : 600};
		if(paddings === undefined){ 
			paddings = {top : 10, right : 10, bottom : 20, left : 20};
		}
		range = {
			x : [paddings.left, dimensions.width - paddings.right],
			y : [dimensions.height - paddings.bottom, paddings.top]  //large value first !
		}
		if(interval === undefined) interval = 1000;
		if(domains === undefined){
			now = new Date();
			domains = {
				x : [now - 120*interval, now - interval],
				y : [0, 100]
			};
		};
		if(ticks === undefined) ticks = { x : 12, y : 5};
		if(r === undefined) r = 2;
		if(data === undefined) data = [];

		//create chart and it's components
		//plot area, scales, axis, ...
		chart = d3.select(container).append("svg")
			.classed("chart line realtime", true)
			.attr("width", dimensions.width)
			.attr("height", dimensions.height);
			
		scales = {
			x : d3.time.scale().range(range.x).domain(domains.x),
			y : d3.scale.linear().range(range.y).domain(domains.y)
		}
	
		axis = {
			x : d3.svg.axis().scale(scales.x).orient("bottom").ticks(ticks.x),
			y : d3.svg.axis().scale(scales.y).orient("left").ticks(ticks.y)
		}

		chart.append("g")
			.classed("axis x", true)
			.attr("transform", "translate(0, " + range.y[0] + ")")
			.call(axis.x);
			
		chart.append("g")
			.classed("axis y", true)
			.attr("transform", "translate(" + range.x[0] + ", 0)")
			.call(axis.y);
		
		chart.append("defs").append("clipPath")
			.classed("clip", true)
			.append("rect")
			.attr("width", range.x[1] - range.x[0])
			.attr("height", range.y[0] - range.y[1]);
		
		initData(data);
		
		//draw path
		line = d3.svg.line().interpolate("basis")
			.x(function(d){ return scales.x(d[0])})
			.y(function(d){ return scales.y(d[1])});		
		
		path = chart.append("g")
			.append("path")
			.data([data])
			.classed("path line", true)
			.attr("d", line);

		function update(count){
			count++;
			//if(--count < 0) return;

			updateData(data);
	
			$(container + " .display").text("interval : " + interval +
				", data size : " + data.length +
				", count : " + count);

			now = new Date();
			domains.x = [now - 120*interval, now - interval];
			scales.x.domain(domains.x);

			chart.select(".path.line").attr("d", line)
				.attr("transform", null);

			chart.select("g.axis.x").transition()
				.duration(interval)
				.ease("linear")
				.call(axis.x);

			path.transition()
				.duration(interval).ease("linear")
				.attr("transform", "translate(" + (scales.x(now - 121*interval) - range.x[0]) + ")")
				.each("end", update);

			data.shift();

		};
		
		update();
	};
	
	var dimensions0 = {width : 400, height : 300};
	var paddings0 = {top : 10, right : 10, bottom : 20, left : 30};
	var interval0 = 1000;
	var now0 = Date.now();
	var domains0 = {
		x : [now0 - 120*interval0, now0 - interval0],
		y : [0, 100]
	};
	var ticks0 = { x : 12, y : 5}
	realtimeChart({
		container : "#chart1",
		dimensions : dimensions0, 		
		paddings : paddings0,
		interval : interval0,
		domains : domains0,
		ticks : ticks0,
	}, function(data){
		var times = d3.time.seconds(domains0.x[0], domains0.x[1],
			d3.time.second);
		var i, n;
		
		for(i = 0, n = times.length; i < n; i++){
			data.push([times[i], domains0.y[1]/2 + Math.random()*domains0.y[1]/2]);				
		};
		
		return data;	
	}, function(data){
		data.push([new Date(), domains0.y[1]/2 + Math.random()*domains0.y[1]/2]);
	});
	
	
	realtimeChart({
		container : "#chart2",
		dimensions : dimensions0, 		
		paddings : paddings0,
		interval : interval0,
		domains : domains0,
		ticks : ticks0,
	}, function(data){
		var times = d3.time.seconds(domains0.x[0], domains0.x[1],
			d3.time.second);
		var i, n;
		
		for(i = 0, n = times.length; i < n; i++){
			data.push([times[i], Math.random()*domains0.y[1]]);				
		};
		
		return data;	
	}, function(data){
		data.push([new Date(), Math.random()*domains0.y[1]]);
	});

	</script>





</body>
</html>
