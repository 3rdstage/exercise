<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>D3.js Exercise - Real-time line chart</title>
<link rel="stylesheet" href="../../../styles/bootstrap/bootstrap.min.css">
<script type="text/javascript" src="../../../scripts/underscore/underscore.js"></script>
<script type="text/javascript" src="../../../scripts/jquery/js/jquery-1.8.0.min.js"></script>
<script type="text/javascript" src="../../../scripts/bootstrap/bootstrap.min.js"></script>
<script type='text/javascript' src='../../../scripts/d3/d3.min.js'></script>
<script type='text/javascript' src='../../../scripts/moment/moment-with-langs.js'></script>


	<style type="text/css">
		body {
			margin-left:20px;
		}

		.chart .axis path, .chart .axis line{
			fill:none;
			stroke:black;
			shape-rendering:crispEdges;
		}

		.chart .axis text{
			font-family:sans-serif;
			font-size:11px;
		}

		.chart path{
			fill:none;
			stroke:black;
		}

	</style>
</head>
<body>


	<div class="panel-group" id="accordion">
		<div class="panel panel-default">
			<div class="pannel-heading">
				<h4 class="pannel-title">
					<a data-toggle="collapse" data-parent="#accordion" href="#chart">
					Exercise time scale
					</a>
				</h4>
			</div>
			<div id="chart" class="panel-collapse">
				<div id="display" style="margin-top:10px">
				</div>
			</div>
		</div>
	</div>


	<script>
	"use strict";

	/*
	 * Glossary
	 * chart, axis, grid, guideline, tick, plot area, axis label, data label, legend, title, source
	 * path or line, bar, ...
	 */

	var dimensions = {width : 1000, height : 400};
	var paddings = {top : 20, right : 30, bottom : 40, left : 250};
	var area = {
		x : [paddings.left, dimensions.width - paddings.right],
		y : [dimensions.height - paddings.bottom, paddings.top]  //large value first !
	}
	var interval = 1000;
	var now = new Date();
	var domains = {
		x : [now - 120*interval, now - interval],
		y : [0, 100]
	};
	var r = 3;
	var scales = {};
	var axis = {};
	var data = [];
	var line = {};
	var path = {};
	var timeDomainLength = domains.x[1] - domains.x[0];
	var lastTimestamp;

	//create scales
	scales = {
		x : d3.time.scale().range(area.x).domain(domains.x),
		y : d3.scale.linear().range(area.y).domain(domains.y)
	}

	//create pannel
	d3.select("#chart").insert("svg", "div")
		.classed("chart", true)
		.attr("width", dimensions.width)
		.attr("height", dimensions.height);
		//.style("background-color", "white");

	axis = {
		x : d3.svg.axis().scale(scales.x).orient("bottom").ticks(10),
		y : d3.svg.axis().scale(scales.y).orient("left").ticks(10)
	}

	d3.select("#chart svg").append("g")
		.classed("axis x x-axis", true)
		.attr("transform", "translate(0, " + area.y[0] + ")")
		.call(axis.x);

	d3.select("#chart svg").append("g")
		.classed("axis y", true)
		.attr("transform", "translate(" + area.x[0] + ", 0)")
		.call(axis.y);

	/*
	d3.select("#chart svg").append("clipPath")
		.attr("id", "clip")
		.append("rect")
		.attr("width", dimensions.width)
		.attr("height", dimensions.height);
	*/

	function draw(){
		initData(data);

		line = d3.svg.line()
			.interpolate("basis")
			.x(function(d){ return scales.x(d[0])})
			.y(function(d){ return scales.y(d[1])});

		path = d3.select("#chart svg").append("g")
			.attr("clip-path", "url(#clip)")
			.append("path")
			.data([data])
			.classed("path line", true)
			.attr("d", line);

		lastTimestamp = data[data.length - 1][0];

	};

	function initData(data){
		var times = d3.time.seconds(domains.x[0], domains.x[1],
			d3.time.second);
		var i, n; //variables for loop

		for(i = 0, n = times.length; i < n; i++){
			data[i] = [times[i], getY()];
		}
	};

	function update(count){
		//if(--count < 0) return;

		updateData(data, 1);

		$("#display").text("interval : " + interval + ", data size : " + data.length);

		now = new Date();
		domains.x = [now - 120*interval, now - interval];
		scales.x.domain(domains.x);
		//scales.x.domain(domains.x);

		d3.select("#chart svg").select(".path").attr("d", line)
			.attr("transform", null);

		d3.select("#chart svg g.axis.x").transition().duration(interval).ease("linear").call(axis.x);

		path.transition()
			.duration(interval).ease("linear")
			.attr("transform", "translate(" + (scales.x(now - 121*interval) - area.x[0]) + ")")
			.each("end", update);

		data.shift();

	};

	function updateData(data, second){
		var last = data[data.length - 1];
		data.push([moment().toDate(), getY()]);
	};

	function getY(){
		return Math.round(domains.y[1]/2 + Math.random()*domains.y[1]/2);
	};

	draw();
	update(60);

	</script>





</body>
</html>
