<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SVG Editor Prototype</title>
<link rel="stylesheet" media="screen" href="../../../styles/bootstrap/bootstrap.min.css">
</head>
<body style="margin-left:40px">
	
	
<svg id='panel1' style="width:800px;height:400px;border:1px solid blue">
</svg>
<br/>
<div id='pallette1' class='btn-group'>
	<button id='addCircleButton' type='button' class='btn btn-default'>Circle</button>
	<button id='addRectangle' type='button' class='btn btn-default'>Rectangle</button>
	<input name='memo' type='text'/>
</div>

<div id='srcView1' style="width:800px;height:400px;border:1px dotted gray">

<script src="../../../scripts/jquery/js/jquery-1.8.0.min.js"></script>
<script src="../../../scripts/underscore/underscore.js"></script>
<script src="../../../scripts/bootstrap/bootstrap.min.js"></script>
<script src="../../../scripts/svg.js/svg.js"></script>
<script src="../../../scripts/svg.js/svg.draggable.js"></script>
<script>
;(function(window, doc, $, usesStrict, undefined){
	if(usesStrict){ "use strict"; };
	
	window.svgeditor = function(element){
		
		if(SVG.supported){
			var editor = new svgeditor.Editor(element);
			if(!SVG.parser) SVG.prepare(editor);
			return editor;
		};
	};
	
	svgeditor.Editor = SVG.invent({
		create : function(element){
			this.nodes = [];
			this.connectors = [];
			this.selectedNode = null;
			this.drawingConnector = null;
			var that = this;
			
			SVG.Doc.call(that, element);
			
			window.onkeyup = function(ev){
				if(ev.keyCode === 27){
					//$('#pallette1 > input[name="memo"]').val(ev.keyCode);
					that.connecting(false);
					that.mousemove(null);
				}
			};
		},
		
		inherit: function(){
			return Object.create(SVG.Doc.prototype);
		},
		
		extend : {
			
			select : function(node){},
			
			unselect: function(){},	
		
			connecting : (function(){
				var is = false;
				
				return function(){
					var self = this;
					var connector = null;
					var anchor0, anchor1;
					var x0, y0;
					var x1, y1;
					
					if(arguments.length === 0){
						return is;
					}else{
						is = arguments[0];
						
						if(is){
							self.mousemove(function(ev){
								anchor0 = self.startAnchor();
								x0 = anchor0.cx() + anchor0.parent.x();
								y0 = anchor0.cy() + anchor0.parent.y();
								x1 = ev.clientX - self.x() - self.node.offsetLeft;
								y1 = ev.clientY - self.y() - self.node.offsetTop;
								
								if(connector == null){
									connector = self.polyline([[x0, y0], [(x0 + x1)/2, y0], [(x0 + y1)/2, y1], [x1, y1]])
										.fill('none').stroke({width:1});
								}else{
									connector.plot([[x0, y0], [(x0 + x1)/2, y0], [(x0 + x1)/2, y1], [x1, y1]]);
								};
							});
						};
						return self;
					}
				};
			})(),
			
			startAnchor : (function(){
				var anchor = null;
				var self = this;
				
				return function(){
					if(arguments.length === 0){
						return anchor;
					}else{
						if(anchor != null) anchor.fill('white');
						anchor = arguments[0];
						return self;
					}
				};
			})()
		},
	});
	
	
	svgeditor.Editable = SVG.invent({
		create : function(){
		},	
		
		inherit: SVG.G,
		parent : svgeditor.Editor,		

		extend : {
			addDefaultClickHandler : function(obj){
				
				obj.click(function(){
					if(this.selected()){
						this.fixed();
						this.selected(false);
					}else{
						this.dragend = function(d, ev){
							this.data("dragging", false);
							this.selected(true);
							ev.stopPropagation();
						}
						this.draggable();
						this.selected(true);
					}
				});	
			}
		},

		construct : {
		
			//@NOTES can be removed?
			editable : function(x, y, name, type){
					var nd = new svgeditor.Editable();
					nd.center(x, y);	
					this.put(nd);
					return nd;
			}
		}
	});
	
	svgeditor.Action = SVG.invent({
		create : function(width, height, name){
			var g = SVG.create('g');
			this.constructor.call(this, g);
			this.type = "action";
			this.name = name;
			this.body = (new SVG.Rect).size(width, height);
			this.anchors = [];
			
			var self = this;
			var i = 0, n; 
			
			self.body.fill('white').stroke('black');
			self.add(self.body);
			
			self.anchors[i++] = this.anchor(3).center(width/2, 0);
			
			for(i = 0, n = self.anchors.length; i < n; i++){
				self.add(self.anchors[i]);
			};
			
			self.addDefaultClickHandler(self);
			
		},
		
		inherit: svgeditor.Editable,
		parent : svgeditor.Editor,
		
		extend : {
			selected : function(val){
				if(arguments.length === 0){
					if(this._selected === undefined) this._selected = false;
					return this._selected;
				}else{
					this._selected = val;
					this.body.stroke(val ? 'red' : 'black');
					return this;
				}
			}
		},
		
		construct: {
			action : function(width, height, name){
				var ac = new svgeditor.Action(width, height, name);
				ac.name = name;
				ac.type = "action";
				this.put(ac);
				return ac;
			}
			
		}
	});
	
	svgeditor.Anchor = SVG.invent({
		create : function(r){
			this.constructor.call(this, SVG.create('ellipse'));
			var self = this;
			
			self.size(r, r).fill('white').stroke('black');
		}, 
		inherit : SVG.Ellipse,
		parent : svgeditor.Editable,
		
		construct : {
			anchor : function(r){
				var ac = new svgeditor.Anchor(r);
				return ac;
			}
		}
	});
	
	
	

})(window, window.document, window.jQuery, true);

var editor = new svgeditor('panel1');
var action1 = editor.action(50, 50, "action1").center(100, 100);
var action2 = editor.action(75, 75, "action2").center(300, 300);
var ac1 = action1.anchor(5);
ac1.fill('white').stroke('black').center(200, 200);


$('#srcView1').text($('#panel1').html());

</script>
</body>
</html>